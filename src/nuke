#!/bin/bash
CONFIG="$HOME/.nuke_config"

if [[ ! -f "$CONFIG" ]]; then
    clear; echo -e "\033[1;31mNUKE v2 — choose provider\033[0m"
    echo "1) Gemini (FREE)  2) Groq  3) OpenAI  4) OpenRouter"
    read -p "→ " c
    case $c in
        1) read -p "Gemini API Key: " k; echo "PROVIDER=gemini"; echo "GEMINI_KEY=$k"; echo "MODEL=gemini-1.5-flash-latest" > "$CONFIG" ;;
        2) read -p "Groq API Key: " k; echo "PROVIDER=groq"; echo "GROQ_KEY=$k"; echo "MODEL=llama3-70b-8192" > "$CONFIG" ;;
        3) read -p "OpenAI API Key: " k; echo "PROVIDER=openai"; echo "OPENAI_KEY=$k"; echo "MODEL=gpt-4o-mini" > "$CONFIG" ;;
        4) read -p "OpenRouter API Key: " k; echo "PROVIDER=openrouter"; echo "OR_KEY=$k"; echo "MODEL=anthropic/claude-3.5-sonnet" > "$CONFIG" ;;
    esac >> "$CONFIG"
    echo -e "\033[32mSaved! Restart nuke.\033[0m"; exit
fi
source "$CONFIG"

clear
echo -e "\033[1;31m   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
           press r → it runs\033[0m"

send() {
    case $PROVIDER in
        gemini)
            curl -s "https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent?key=$GEMINI_KEY" \
                -H 'Content-Type: application/json' \
                -d "{\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"$1\"}]}]}" 2>/dev/null \
                | jq -r '.candidates[0].content.parts[0].text // "API error"' 2>/dev/null
            ;;
        groq|openai|openrouter) 
            # existing working code (unchanged)
            curl -s $URL/v1/chat/completions -H "Authorization: Bearer $KEY" \
                -H "Content-Type: application/json" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$1\"}]}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
    esac
}

while :; do
    read -p "▸ " input
    [[ "$input" == "q" ]] && exit
    [[ "$input" == "c" ]] && rm "$CONFIG"; exec "$0"

    if [[ "$input" =~ ^ex[[:space:]]+(.+) ]]; then
        echo -e "\033[90mexplaining ${BASH_REMATCH[1]}...\033[0m"
        resp=$(send "Explain the Linux/Kali command '${BASH_REMATCH[1]}' simply + give ONE real pentest/CTF example with code block.")
        echo -e "\033[36m$resp\033[0m"
        read -n1 -p "Press any key..."
        clear; continue
    fi

    echo -e "\033[90mthinking...\033[0m"
    resp=$(send "Kali expert: ONLY the single best command for '$input'. No explanation.")
    echo -e "\033[32m$resp\033[0m"
    read -n1 -p $'\033[33m[r] Run • [q] Quit → \033[0m' k; echo
    [[ "$k" == "r" ]] && echo "$resp" | bash
    clear
done
