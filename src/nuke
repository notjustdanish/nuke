#!/bin/bash
# nuke — low-RAM fix by wtf.mr

pgrep -f "ollama serve" > /dev/null || ollama serve > /dev/null 2>&1 &
sleep 3

clear
echo -e "\033[1;31mNUKE — press r → it runs (low-RAM mode)\033[0m"

# Try 7B first, fallback to 3B if memory error
MODEL="qwen2.5:7b-instruct-q5_K_M"
if ! ollama list | grep -q "$MODEL"; then
    MODEL="qwen2.5:3b-instruct-q4_0"
    ollama pull "$MODEL"  # Auto-pull if missing
fi

while :; do
    read -p "▸ " query
    [[ "$query" =~ ^[qQ]$ ]] && exit 0

    echo -e "\033[90mthinking...\033[0m"
    timeout 30 ollama run "$MODEL" "Kali Linux expert: Give ONLY the single best command for '$query'. No explanation." 2>/dev/null | tail -n 10 || {
        echo -e "\033[31mHang — switching to small model\033[0m"
        MODEL="qwen2.5:3b-instruct-q4_0"
        timeout 30 ollama run "$MODEL" "Kali Linux expert: Give ONLY the single best command for '$query'. No explanation." 2>/dev/null | tail -n 10
    }

    read -n1 -p $'\033[33m[r] Run • [q] Quit \033[0m' key; echo
    [[ $key == "r" ]] && echo "Paste command here and run manually for now."
done
