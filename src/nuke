#!/bin/bash
CONFIG="$HOME/.nuke_config"

[[ ! -f "$CONFIG" ]] && {
    clear
    echo -e "\033[1;34m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
        Learn Linux the easy way
\033[0m"
    read -p "Enter your free Gemini API key[](https://aistudio.google.com/app/apikey): " k
    echo "PROVIDER=gemini" > "$CONFIG"
    echo "GEMINI_KEY=$k" >> "$CONFIG"
    echo "MODEL=gemini-1.5-flash-latest" >> "$CONFIG"
    echo -e "\033[32mSaved! Restart nuke.\033[0m"
    exit 0
}

source "$CONFIG"

clear
echo -e "\033[1;34m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
        type 'ex ls' to learn any command
\033[0m"

send() {
    curl -s "https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent?key=$GEMINI_KEY" \
        -H 'Content-Type: application/json' \
        -d "{\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"$1\"}]}]}" 2>/dev/null \
        | jq -r '.candidates[0].content.parts[0].text // "No response"' 2>/dev/null
}

while :; do
    printf "▸ "
    read -r input

    [[ "$input" == "q" ]] && { clear; echo -e "\033[34mHappy learning!\033[0m"; exit; }

    # === EXPLAIN COMMAND (for beginners) ===
    if [[ "$input" == ex* ]] && [[ ${#input} -gt 3 ]]; then
        cmd="${input:3}"
        echo -e "\033[90mExplaining: $cmd\033[0m"
        exp=$(send "You are a friendly Linux teacher for beginners. Explain the command '$cmd' in very simple, formal English. Then give one clean, beginner-friendly example. Use short sentences. Be kind and clear.")
        echo -e "\033[36m$exp\033[0m"
        read -n1 -s -r -p $'\033[33mPress any key to continue...\033[0m'
        clear
        continue
    fi

    # === NORMAL LEARNING QUERY ===
    echo -e "\033[90mThinking...\033[0m"
    resp=$(send "You are a kind Linux teacher for beginners. The user asked: '$input'. Give only one simple, safe, educational command. No explanation. No danger.")
    [[ "$resp" == "No response" ]] && resp="Try asking something like: 'how to list files' or 'ex ls'"
    echo -e "\033[32m$resp\033[0m"

    read -n1 -s -r -p $'\033[33m[r] Run • [ENTER] Copy • [q] Quit → \033[0m' k; echo
    [[ "$k" == "r" ]] && echo "$resp" | bash 2>/dev/null
    clear
done
