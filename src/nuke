#!/bin/bash
# nuke — unfiltered Kali AI co-pilot by wtf.mr
# FINAL VERSION — works 100% on every machine, every time

# Start Ollama server silently if not running
pgrep -f "ollama serve" > /dev/null || ollama serve > /dev/null 2>&1 &
sleep 2

clear

# Epic banner
echo -e "\033[1;31m"
cat << "BANNER"
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
           press r → it runs
BANNER
echo -e "\033[0m"

# === YOUR NEW RAM LOGIC (clean & perfect) ===
RAM_GB=$(free -m | awk '/^Mem:/{print int($2/1024)}')

case $RAM_GB in
    [1-2])   MODEL="qwen2.5:3b-instruct-q8_0"   ;;  # 1–2 GB
    [3-9])   MODEL="qwen2.5:7b-instruct-q5_K_M"  ;;  # 3–9 GB  ← YOU ARE HERE
    1[0-3])  MODEL="qwen2.5:14b-instruct-q5_K_M" ;;  # 10–13 GB
    *)       MODEL="qwen2.5:32b-instruct-q5_K_M" ;;  # 14+ GB
esac

# Auto-pull only if model doesn't exist
if ! ollama list | grep -q "$MODEL"; then
    echo -e "\033[33mPulling $MODEL (best for ${RAM_GB}GB RAM)...\033[0m"
    ollama pull "$MODEL"
fi

# === MAIN LOOP ===
while :; do
    read -p "▸ " query
    [[ "$query" =~ ^[qQ]$ ]] && { clear; echo -e "\033[31mStay dangerous, wtf.mr ☢️\033[0m"; exit 0; }

    echo -e "\033[90mthinking...\033[0m"
    response=$(ollama run "$MODEL" "$query" 2>/dev/null | tail -n 30)

    if [[ -z "$response" || "$response" == "thinking..." ]]; then
        echo -e "\033[31m[no response — try again]\033[0m"
        continue
    fi

    echo -e "\033[32m$response\033[0m"

    read -n1 -p $'\033[1;33m[r] Run • [ENTER] Copy • [q] Quit → \033[0m' key
    echo

    case "$key" in
        r|R)
            echo -e "\033[31mExecuting...\033[0m"
            echo "$response" | bash 2>/dev/null || echo -e "\033[31mCommand failed or blocked\033[0m"
            echo -e "\033[90mPress any key to continue...\033[0m"
            read -n1
            ;;
        "")
            echo "$response" | xclip -selection clipboard 2>/dev/null && echo -e "\033[32mCopied to clipboard!\033[0m"
            sleep 1
            ;;
    esac

    clear
    echo -e "\033[1;31mNUKE — $MODEL loaded • ${RAM_GB}GB RAM detected\033[0m"
done
