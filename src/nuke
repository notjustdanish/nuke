#!/bin/bash
# nuke v2 — FIXED regex + ex command + auto model detection
# by wtf.mr — 2025 legendary edition (no more "fade away")

CONFIG="$HOME/.nuke_config"

# === FIRST TIME SETUP ===
if [[ ! -f "$CONFIG" ]]; then
    clear
    echo -e "\033[1;31m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
        v2 — fixed + ex command
\033[0m"

    echo -e "\033[33mChoose provider:\033[0m"
    echo "1) Google Gemini (FREE)"
    echo "2) Groq"
    echo "3) OpenAI"
    echo "4) OpenRouter"
    read -p "→ " c

    case $c in
        1) read -p "Gemini API Key: " k; echo "PROVIDER=gemini"; echo "GEMINI_KEY=$k"; echo "MODEL=gemini-1.5-flash-latest"; NAME="Gemini 1.5 Flash" ;;
        2) read -p "Groq API Key: " k; echo "PROVIDER=groq"; echo "GROQ_KEY=$k"; echo "MODEL=llama3-70b-8192"; NAME="Groq Llama3-70B" ;;
        3) read -p "OpenAI API Key: " k; echo "PROVIDER=openai"; echo "OPENAI_KEY=$k"; echo "MODEL=gpt-4o-mini"; NAME="GPT-4o-mini" ;;
        4) read -p "OpenRouter API Key: " k; echo "PROVIDER=openrouter"; echo "OR_KEY=$k"; echo "MODEL=anthropic/claude-3.5-sonnet"; NAME="Claude-3.5 Sonnet" ;;
        *) exit 1 ;;
    esac > "$CONFIG"

    echo -e "\033[32mSaved! Restart nuke.\033[0m"; exit
fi

source "$CONFIG"

clear
echo -e "\033[1;31m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
           press r → it runs
\033[0m"
echo -e "Brain: \033[1;33m$NAME\033[0m · type 'ex nmap' to learn"

# === SEND FUNCTION ===
send() {
    local prompt="$1"
    case $PROVIDER in
        gemini)
            curl -s "https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent?key=$GEMINI_KEY" \
                -H 'Content-Type: application/json' \
                -d "{\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"$prompt\"}]}]}" 2>/dev/null \
                | jq -r '.candidates[0].content.parts[0].text // "API error"' 2>/dev/null
            ;;
        groq)
            curl -s https://api.groq.com/openai/v1/chat/completions \
                -H "Authorization: Bearer $GROQ_KEY" -H "Content-Type: application/json" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}],\"temperature\":0.3,\"max_tokens\":512}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
        openai)
            curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_KEY" -H "Content-Type: application/json" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}],\"temperature\":0.3}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
        openrouter)
            curl -s https://openrouter.ai/api/v1/chat/completions \
                -H "Authorization: Bearer $OR_KEY" -H "HTTP-Referer: https://github.com/notjustdanish/nuke" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}]}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
    esac
}

# === MAIN LOOP ===
while :; do
    read -p "▸ " input
    echo "DEBUG: Input captured = '$input'"  # TEMP DEBUG — remove after testing

    # Quit
    if [[ "$input" =~ ^[qQ]$ ]]; then
        clear
        echo -e "\033[31mStay dangerous, wtf.mr ☢️\033[0m"
        exit 0
    fi

    # Change model
    if [[ "$input" == "c" ]]; then
        rm "$CONFIG"
        echo "Restarting to change model..."
        sleep 1
        exec "$0"
    fi

    # === EX COMMAND (FIXED REGEX — SIMPLE STRING CHECK) ===
    if [[ "$input" == ex* ]] && [[ "$input" != "ex" ]]; then
        cmd=$(echo "$input" | cut -d' ' -f2-)
        echo "DEBUG: Ex command detected = '$cmd'"  # TEMP DEBUG
        echo -e "\033[90mexplaining: $cmd ...\033[0m"
        exp=$(send "Kali Linux master: Explain '$cmd' simply. Then give ONE real pentest/CTF example with code block.")
        if [[ "$exp" == "API error" ]]; then
            echo -e "\033[31mFailed — check internet/key\033[0m"
        else
            echo -e "\033[36m$exp\033[0m"
        fi
        read -n1 -p $'\033[33mPress any key to continue...\033[0m'
        clear
        echo -e "\033[1;31mNUKE v2 — $NAME · type 'ex nmap' to learn\033[0m"
        continue
    fi

    # === NORMAL QUERY ===
    echo -e "\033[90mthinking...\033[0m"
    resp=$(send "Kali Linux expert. Give ONLY the single best command for: '$input'. No explanation, no quotes, no markdown.")
    if [[ "$resp" == "API error" ]]; then
        resp="API error — check key/internet"
    fi

    echo -e "\033[32m$resp\033[0m"
    read -n1 -p $'\033[1;33m[r] Run • [ENTER] Copy • [c] Change • [q] Quit → \033[0m' act
    echo

    case "$act" in
        r|R)
            echo -e "\033[31mExecuting...\033[0m"
            echo "$resp" | bash 2>/dev/null || echo -e "\033[31mCommand failed\033[0m"
            read -n1 -p "Press any key..."
            ;;
        "")
            echo "$resp" | xclip -selection clipboard 2>/dev/null && echo -e "\033[32mCopied to clipboard!\033[0m"
            sleep 1
            ;;
        c)
            rm "$CONFIG"
            echo "Restarting to change model..."
            sleep 1
            exec "$0"
            ;;
    esac

    clear
    echo -e "\033[1;31mNUKE v2 — $NAME · type 'ex ls' to learn\033[0m"
done
