#!/bin/bash
# nuke v2 — FULLY FUTURE-PROOF GEMINI + ex command + auto model detection
# by wtf.mr — 2025+ legendary edition

CONFIG="$HOME/.nuke_config"

# === FIRST TIME SETUP ===
if [[ ! -f "$CONFIG" ]]; then
    clear
    echo -e "\033[1;31m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
        v2 — auto latest model
\033[0m"

    echo -e "\033[33mChoose provider:\033[0m"
    echo "1) Google Gemini (FREE — auto uses latest: 2.5 Flash / 3.0 / etc)"
    echo "2) Groq"
    echo "3) OpenAI"
    echo "4) OpenRouter"
    read -p "→ " c

    case $c in
        1)
            read -p "Gemini API Key[](https://aistudio.google.com/app/apikey): " k
            echo "PROVIDER=gemini" > "$CONFIG"
            echo "GEMINI_KEY=$k" >> "$CONFIG"
            # AUTO DETECT LATEST GEMINI MODEL (2.5 Flash, 3.0, etc)
            LATEST=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=$k" \
                | jq -r '.models[].name' | grep -i "gemini" | grep -iv "experimental" | tail -1 | cut -d/ -f2)
            [[ -z "$LATEST" ]] && LATEST="gemini-1.5-flash-latest"
            echo "MODEL=$LATEST" >> "$CONFIG"
            NAME="Gemini $(echo $LATEST | cut -d- -f2- | tr '-' ' ')"
            ;;
        2) read -p "Groq API Key: " k; echo "PROVIDER=groq"; echo "GROQ_KEY=$k"; echo "MODEL=llama3-70b-8192"; NAME="Groq Llama3-70B" ;;
        3) read -p "OpenAI API Key: " k; echo "PROVIDER=openai"; echo "OPENAI_KEY=$k"; echo "MODEL=gpt-4o-mini"; NAME="GPT-4o-mini" ;;
        4) read -p "OpenRouter API Key: " k; echo "PROVIDER=openrouter"; echo "OR_KEY=$k"; echo "MODEL=anthropic/claude-3.5-sonnet"; NAME="Claude-3.5 Sonnet" ;;
        *) exit 1 ;;
    esac >> "$CONFIG"

    echo -e "\033[32mConnected! Using: $NAME\033[0m"
    sleep 2
fi

source "$CONFIG"

clear
echo -e "\033[1;31m
   _   __      __      __
  / | / /_  __/ /_____/_/
 /  |/ / / / / //_/ _/_/
/_/|_/ /___/ /_/  /___/
           press r → it runs
\033[0m"
echo -e "Brain: \033[1;33m$NAME\033[0m · type 'ex nmap' to learn"

# === SEND FUNCTION (Gemini now uses $MODEL dynamically) ===
send() {
    local prompt="$1"
    case $PROVIDER in
        gemini)
            curl -s "https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent?key=$GEMINI_KEY" \
                -H 'Content-Type: application/json' \
                -d "{\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"$prompt\"}]}]}" 2>/dev/null \
                | jq -r '.candidates[0].content.parts[0].text // "API error"' 2>/dev/null
            ;;
        groq)
            curl -s https://api.groq.com/openai/v1/chat/completions \
                -H "Authorization: Bearer $GROQ_KEY" -H "Content-Type: application/json" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}],\"temperature\":0.3,\"max_tokens\":512}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
        openai)
            curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_KEY" -H "Content-Type: application/json" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}],\"temperature\":0.3}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
        openrouter)
            curl -s https://openrouter.ai/api/v1/chat/completions \
                -H "Authorization: Bearer $OR_KEY" -H "HTTP-Referer: https://github.com/notjustdanish/nuke" \
                -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}]}" 2>/dev/null \
                | jq -r '.choices[0].message.content // "API error"' 2>/dev/null
            ;;
    esac
}

# === MAIN LOOP (with ex command) ===
while :; do
    read -p "▸ " input
    [[ "$input" =~ ^[qQ]$ ]] && { clear; echo -e "\033[31mStay dangerous, wtf.mr\n"; exit 0; }
    [[ "$input" == "c" ]] && { rm "$CONFIG"; echo "Restarting to change model..."; sleep 1; exec "$0"; }

    # === ex COMMAND ===
    if [[ "$input" =~ ^ex[[:space:]]+(.+) ]]; then
        cmd="${BASH_REMATCH[1]}"
        echo -e "\033[90mexplaining: $cmd ...\033[0m"
        exp=$(send "Kali Linux master: Explain '$cmd' simply. Then give ONE real pentest/CTF example with code block.")
        [[ "$exp" == "API error" ]] && exp="Failed — check connection"
        echo -e "\033[36m$exp\033[0m"
        read -n1 -p "Press any key..."
        clear
        echo -e "\033[1;31mNUKE v2 — $NAME\033[0m"
        continue
    fi

    # === NORMAL MODE ===
    echo -e "\033[90mthinking...\033[0m"
    resp=$(send "Kali expert: ONLY the single best command for '$input'. No explanation.")
    [[ "$resp" == "API error" ]] && resp="API error"

    echo -e "\033[32m$resp\033[0m"
    read -n1 -p $'\033[1;33m[r] Run • [ENTER] Copy • [c] Change • [q] Quit → \033[0m' a; echo
    case "$a" in
        r|R) echo -e "\033[31mExecuting...\033[0m"; echo "$resp" | bash 2>/dev/null || echo "failed"; read -n1 ;;
        "")  echo "$resp" | xclip -selection clipboard 2>/dev/null; echo "Copied!" ;;
        c)   rm "$CONFIG"; exec "$0" ;;
    esac
    clear
    echo -e "\033[1;31mNUKE v2 — $NAME · type 'ex nmap' to learn\033[0m"
done
