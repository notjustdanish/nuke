#!/bin/bash
# nuke — unfiltered Kali AI co-pilot by wtf.mr
# Auto-detects RAM → forces the BEST possible qwen2.5 model
# Works on 4GB laptops and 64GB beasts — forever.
# Hide Ollama's startup spam
export OLLAMA_HOST=127.0.0.1:11434 2>/dev/null
clear

# === ASCII ART (red) ===
echo -e "\033[31m"
cat << "ASCII"
███╗   ██╗██╗   ██╗██╗  ██╗███████╗
████╗  ██║██║   ██║██║ ██╔╝██╔════╝
██╔██╗ ██║██║   ██║█████╔╝ █████╗  
██║╚██╗██║██║   ██║██╔═██╗ ██╔══╝  
██║ ╚████║╚██████╔╝██║  ██╗███████╗
╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝
           press r → it runs
ASCII
echo -e "\033[0m"

# === AUTO MODEL SELECTOR + UPGRADE LOGIC ===
RAM_GB=$(free -m | awk '/^Mem:/{printf "%d", $2/1024}')

case $RAM_GB in
    [1-2])   BEST="qwen2.5:3b-instruct-q8_0"   ;;  # 4–5 GB  → fast + smart
    [3-9])   BEST="qwen2.5:7b-instruct-q5_K_M" ;;  # 6–9 GB  → very fast
    1[0-3])  BEST="qwen2.5:14b-instruct-q5_K_M";;  # 10–13 GB → beast
    *)       BEST="qwen2.5:32b-instruct-q5_K_M";;  # 14+ GB  → god mode
esac

# Detect current default model
CURRENT=$(ollama list 2>/dev/null | awk 'NR==2 {print $1}' | cut -d: -f1)

# Auto-upgrade if trash model is active
if [[ "$CURRENT" == "phi3" ]] || [[ "$CURRENT" == "gemma"* ]] || [[ -z "$CURRENT" ]]; then
    echo -e "\033[33mUpgrading weak model → pulling $BEST (best for ${RAM_GB}GB RAM)\033[0m"
    ollama rm "$CURRENT" 2>/dev/null || true
    ollama pull "$BEST"
fi

MODEL="$BEST"

# === MAIN LOOP ===
while :; do
    read -p "▸ " query
    [[ "$query" =~ ^[qQ]$ ]] && echo -e "\n\033[31mExited. Stay dangerous, wtf.mr\033[0m" && exit 0

    echo -e "\033[90mthinking...\033[0m"
    response=$(ollama run "$MODEL" "$query" 2>/dev/null | grep -v "^$" | tail -n 20)

    if [[ -z "$response" ]]; then
        echo -e "\033[31m[error] no response — try again\033[0m"
        continue
    fi

    echo -e "\033[32m$response\033[0m"

    read -n1 -p $'\033[33m[r] Run • [SPACE] Details • [ENTER] Copy • [q] Quit \033[0m' key
    echo

    case "$key" in
        r|R) 
            echo -e "\033[31mExecuting...\033[0m"
            echo "$response" | bash 2>/dev/null || echo -e "\033[31mCommand failed or unsafe\033[0m"
            echo -e "\033[90mFinished. Press any key...\033[0m"
            read -n1
            ;;
        " ") 
            echo -e "\033[34m$response\033[0m"
            read -n1 -p "Press any key to continue..."
            ;;
        "") 
            echo "$response" | xclip -selection clipboard
            echo -e "\033[32mCopied to clipboard!\033[0m"
            ;;
    esac
    clear
    echo -e "\033[31m"  # re-print ASCII
    cat << "ASCII"
███╗   ██╗██╗   ██╗██╗  ██╗███████╗
████╗  ██║██║   ██║██║ ██╔╝██╔════╝
██╔██╗ ██║██║   ██║█████╔╝ █████╗  
██║╚██╗██║██║   ██║██╔═██╗ ██╔══╝  
██║ ╚████║╚██████╔╝██║  ██╗███████╗
╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝
           press r → it runs
ASCII
    echo -e "\033[0m"
done
